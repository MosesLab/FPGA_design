-------------------------------------------------------------------------------
--$Date: 2007/08/01 23:10:49 $
--$RCSfile: example_tb_vhd.ejava,v $
--$Revision: 1.1.2.1 $
--------------------------------------------------------------------------------
--   ____  ____ 
--  /   /\/   / 
-- /___/  \  /    Vendor: Xilinx 
-- \   \   \/     Version : 1.7
--  \   \         Application : GTP Wizard 
--  /   /         Filename : example_tb.vhd
-- /___/   /\     Timestamp : 
-- \   \  /  \ 
--  \___\/\___\ 
--
--
-- Module EXAMPLE_TB
-- Generated by Xilinx GTP Wizard
library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;
library UNISIM;
use UNISIM.VCOMPONENTS.ALL;
use work.ctiUtil.all;
use work.ctiSim.all;
use work.txt_util.all;

library modelsim_lib;
use modelsim_lib.util.all;

entity EXAMPLE_TB is
end EXAMPLE_TB;

architecture RTL of EXAMPLE_TB is

--*************************Parameter Declarations******************************

    constant   REFCLK_PERIOD        :   time :=  10.0 ns;
  
--**************************** Component Declarations *************************

    component EXAMPLE_MGT_TOP 
    generic
    (
        EXAMPLE_CONFIG_INDEPENDENT_LANES: integer    := 1;
        EXAMPLE_LANE_WITH_START_CHAR    : integer    := 0;
        EXAMPLE_WORDS_IN_BRAM           : integer    := 512;
        EXAMPLE_SIM_GTPRESET_SPEEDUP    : integer    := 1;
        EXAMPLE_SIM_PLL_PERDIV2         : bit_vector := x"190";
        EXAMPLE_USE_CHIPSCOPE           : integer    := 1     -- Set to 1 to use Chipscope to drive resets
    );
    port
    (
        TILE0_REFCLK_PAD_N_IN   :   in std_logic;
        TILE0_REFCLK_PAD_P_IN   :   in std_logic; 
        GTPRESET_IN                       :   in std_logic; 
        TILE0_PLLLKDET_OUT                :   out std_logic;
        TILE1_PLLLKDET_OUT                :   out std_logic;
        RXN_IN                            :   in std_logic_vector(3 downto 0);
        RXP_IN                            :   in std_logic_vector(3 downto 0);
        TXN_OUT                           :   out std_logic_vector(3 downto 0);
        TXP_OUT                           :   out std_logic_vector(3 downto 0);
	tile0ch0_loopback						: in  std_logic_vector(2 downto 0);
	tile0ch1_loopback						: in  std_logic_vector(2 downto 0);
	tile1ch0_loopback						: in  std_logic_vector(2 downto 0);
	tile1ch1_loopback						: in  std_logic_vector(2 downto 0);
	altClkIn								: in std_logic	
    );
    end component;

    component SIM_RESET_MGT_MODEL 
    port 
    (
        GSR_IN     : in std_logic
    );
    end component;

--************************Internal Register Declarations***********************

--************************** Register Declarations ****************************        

    signal  debounce_pma_reset_r    :   std_logic_vector(0 to 3);
    signal  refclk_n_r              :   std_logic;
    signal  drp_clk_r               :   std_logic;
    signal  tx_usrclk_r             :   std_logic;
    signal  rx_usrclk_r             :   std_logic;    
    signal  gsr_r                   :   std_logic;
    signal  gts_r                   :   std_logic;
    signal  reset_i                 :   std_logic;

--********************************Wire Declarations**********************************
    
    ----------------------------------- Global Signals ------------------------------
    signal  refclk_p_r              :   std_logic;
    signal  tied_to_ground_i        :   std_logic;
    ---------------------------- Example Module Connections -------------------------
    signal  rxn_in_i                :   std_logic_vector(3 downto 0);
    signal  rxp_in_i                :   std_logic_vector(3 downto 0);
    signal  txn_out_i               :   std_logic_vector(3 downto 0);
    signal  txp_out_i               :   std_logic_vector(3 downto 0);


    signal  tile0_error_count0_i   :   std_logic_vector(7 downto 0);
    signal  tile0_error_count1_i   :   std_logic_vector(7 downto 0);
    signal  tile0_plllkdet_i       :   std_logic;
    signal  tile1_error_count0_i   :   std_logic_vector(7 downto 0);
    signal  tile1_error_count1_i   :   std_logic_vector(7 downto 0);
    signal  tile1_plllkdet_i       :   std_logic;

	-- MF signals
	signal connect : std_logic;

	signal t0ch0_framecheck_cnt : std_logic_vector(8 downto 0);
	signal t0ch0_framecheck_startchar : std_logic;	
	signal t0ch0_loopback : std_logic_vector(2 downto 0);
	signal simFinished : boolean  := false;
	
--*********************************Main Body of Code**********************************
begin

    -- ------------------------------- Tie offs -------------------------------   
    tied_to_ground_i        <=  '0';
    
    -- ------------------------- MGT Serial Connections -----------------------
    rxn_in_i                <=  txn_out_i when connect='1' else (others=>'0');
    rxp_in_i                <=  txp_out_i when connect='1' else (others=>'1');  

    ------- Instantiate the ROC module for resetting the VHDL MGT Smart Model ------
    sim_reset_mgt_model_i : SIM_RESET_MGT_MODEL  
    port map    
    (
        GSR_IN           =>           reset_i
    );

    ---------------------- Generate Reference Clock input  --------------------
    process
    begin
        refclk_n_r  <=  '1';
        wait for REFCLK_PERIOD/2;
        refclk_n_r  <=  '0';
        wait for REFCLK_PERIOD/2;
    end process;

    refclk_p_r <= not refclk_n_r;
                      
    ----------------------------------- Resets ---------------------------------
    --process
    --begin
    --    reset_i <= '1';
    --    wait for 100 ns;
     --   reset_i <= '0';
     --   wait; 
    --end process;

    ------------------- Instantiate an EXAMPLE_MGT_TOP module  -----------------
    example_mgt_top_i : EXAMPLE_MGT_TOP
    generic map
    (
        EXAMPLE_SIM_GTPRESET_SPEEDUP        =>  1,        -- Speedup is turned on for simulation
        EXAMPLE_SIM_PLL_PERDIV2             =>  x"1f4",      -- Set to the VCO Unit Interval time
											-- was x190
        EXAMPLE_USE_CHIPSCOPE               =>  0         --1 - use chipscope to drive resets,
                                                          --0 - drive resets from top level ports
    )
    port map
    (
        TILE0_REFCLK_PAD_N_IN       =>  refclk_n_r,   
        TILE0_REFCLK_PAD_P_IN       =>  refclk_p_r,
        GTPRESET_IN                 =>  reset_i,
        TILE0_PLLLKDET_OUT          =>  tile0_plllkdet_i,
        TILE1_PLLLKDET_OUT          =>  tile1_plllkdet_i,
        RXN_IN                      =>  rxn_in_i,
        RXP_IN                      =>  rxp_in_i,
        TXN_OUT                     =>  txn_out_i,
        TXP_OUT                     =>  txp_out_i,
		tile0ch0_loopback			=> t0ch0_loopback,
		tile0ch1_loopback			=> "000",
		tile1ch0_loopback			=> "000",
		tile1ch1_loopback			=> "000",
		altClkIn					=> '0'
    );

    ------------------------------------
	
	-- signal spy
	
    spy_process : process
	begin
        init_signal_spy("/example_tb/example_mgt_top_i/tile0_frame_check0/rx_data_has_start_char_c","/EXAMPLE_TB/t0ch0_framecheck_startchar",1,1);	
        init_signal_spy("/example_tb/example_mgt_top_i/tile0_frame_check0/read_counter_i","/EXAMPLE_TB/t0ch0_framecheck_cnt",1,1);
        wait;
    end process spy_process;
	
	spy_enable_disable : process
	begin
		wait for 1 ns;
        enable_signal_spy("/example_tb/example_mgt_top_i/tile0_frame_check0/rx_data_has_start_char_c","/EXAMPLE_TB/t0ch0_framecheck_startchar",0);			
        enable_signal_spy("/example_tb/example_mgt_top_i/tile0_frame_check0/read_counter_i","/EXAMPLE_TB/t0ch0_framecheck_cnt",0);
		wait;
    end process spy_enable_disable;
        
	--drive_sig_process : process
	--begin
	--	init_signal_driver("/EXAMPLE_TB/t0ch0_loopback", "/example_tb/example_mgt_top_i/pciegtp_wrapper_i/tile0_pciegtp_wrapper_i/loopback0_in", open, open, 1);
	--	wait;
	--end process drive_sig_process;	
	
	tests : process
	begin
	   title("Simulation starting");
	    connect <= '1';
	    t0ch0_loopback <= "000";

		wait for 10 ns;
		
		reset_i <= '1';
        wait for 100 ns;
        reset_i <= '0';
		
		msg("Reset done");
		
		wait for 100 ns;	
		wait until tile0_plllkdet_i = '1';
		msg("PLL ready");
		
		wait until t0ch0_framecheck_startchar = '1';
		msg("Hit start character");
		
		wait until t0ch0_framecheck_cnt = to_stdlogic(16#10#,9);

		msg("Frame check hit 0x10");
		msg("Disconnecting");		
		connect <= '0';
		wait for 100 ns;

		msg("Reconnecting");				
		connect <= '1';		

		wait for 1 us;
		
		
		msg("Change loopback mode - near end PCS (001)");
		connect <= '0';
		t0ch0_loopback <= "001";
		
        reset_i <= '1';
        wait for 100 ns;
        reset_i <= '0';

		wait for 100 ns;	
		wait until tile0_plllkdet_i = '1';
		msg("PLL ready");
		
		--signal_force("/example_tb/example_mgt_top_i/pciegtp_wrapper_i/tile0_pciegtp_wrapper_i/loopback0_in", "001", 0 ns, drive, open, 1);		
		wait for 1 us;
		
		msg("Change loopback mode - near end PMA (010)");
		t0ch0_loopback <= "010";
		
        reset_i <= '1';
        wait for 100 ns;
        reset_i <= '0';
		
		wait for 100 ns;	
		wait until tile0_plllkdet_i = '1';
		msg("PLL ready");		
		
		--signal_force("/example_tb/example_mgt_top_i/pciegtp_wrapper_i/tile0_pciegtp_wrapper_i/loopback0_in", "010", 0 ns, drive, open, 1);				
		wait for 1 us;
		
		title("Finished");
		simFinished <= TRUE;
		
		wait;
	
	end process;
	
end RTL;

